# ë©€í‹° ìŠ¤í…Œì´ì§€ ë¹Œë“œë¥¼ ì‚¬ìš©í•œ íš¨ìœ¨ì ì¸ Docker ì´ë¯¸ì§€ ìƒì„±

# 1ë‹¨ê³„: ë¹Œë“œ ìŠ¤í…Œì´ì§€
FROM eclipse-temurin:17-jdk-alpine AS builder

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# Gradle Wrapperì™€ ì„¤ì • íŒŒì¼ë“¤ ë³µì‚¬
COPY gradle/ gradle/
COPY gradlew .
COPY build.gradle .
COPY settings.gradle .

# ì˜ì¡´ì„± ë‹¤ìš´ë¡œë“œ (ìºì‹œ ìµœì í™”)
RUN chmod +x ./gradlew
RUN ./gradlew dependencies --no-daemon

# ì†ŒìŠ¤ ì½”ë“œ ë³µì‚¬
COPY src/ src/

# application-local.yml ì œê±° (production í™˜ê²½ìš©)
RUN find src/main/resources -name "application-local.yml" -delete

# ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
RUN ./gradlew clean build -x test --no-daemon

# Oracle ë“œë¼ì´ë²„ í¬í•¨ í™•ì¸ (ë””ë²„ê¹…)
RUN echo "ğŸ” ë¹Œë“œëœ JAR íŒŒì¼ì˜ Oracle ë“œë¼ì´ë²„ í™•ì¸:" && \
    jar tf build/libs/*.jar | grep -i oracle | head -5 || echo "Oracle ë“œë¼ì´ë²„ê°€ JARì— í¬í•¨ë˜ì§€ ì•ŠìŒ"

# 2ë‹¨ê³„: ì‹¤í–‰ ìŠ¤í…Œì´ì§€
FROM eclipse-temurin:17-jre-alpine

# í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜ (Alpine ë°©ì‹)
RUN apk add --no-cache \
    curl \
    tzdata

# ì• í”Œë¦¬ì¼€ì´ì…˜ ì‚¬ìš©ì ìƒì„± (Alpine ë°©ì‹)
RUN addgroup -g 1001 -S hanabank && \
    adduser -u 1001 -S hanabank -G hanabank

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# ë¹Œë“œëœ JAR íŒŒì¼ ë³µì‚¬
COPY --from=builder /app/build/libs/*.jar app.jar

# ì†Œìœ ê¶Œ ë³€ê²½
RUN chown -R hanabank:hanabank /app

# ì‚¬ìš©ì ì „í™˜
USER hanabank

# í¬íŠ¸ ë…¸ì¶œ
EXPOSE 8082

# í—¬ìŠ¤ì²´í¬ ì„¤ì •
HEALTHCHECK --interval=30s --timeout=3s --start-period=40s --retries=3 \
  CMD curl -f http://localhost:8082/actuator/health || exit 1

# JVM ì˜µì…˜ ì„¤ì • (ë©”ëª¨ë¦¬ ìµœì í™” - EC2 ìµœì í™”)
ENV JAVA_OPTS="-Xms256m -Xmx768m -XX:+UseG1GC -XX:G1HeapRegionSize=16m -XX:+UseStringDeduplication -XX:+ExitOnOutOfMemoryError -XX:+HeapDumpOnOutOfMemoryError"

# ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰
ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar app.jar"]
